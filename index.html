<!DOCTYPE html>
<html lang="el">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CIP Interactive Viewer</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Markdown parser -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root { color-scheme: light dark; }
    html, body { height: 100%; font-family: Inter, ui-sans-serif, system-ui; }
    .prose h1, .prose h2, .prose h3 { scroll-margin-top: 6rem; }
    .chip { @apply text-xs rounded-full px-2 py-0.5 bg-neutral-100 dark:bg-neutral-800; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium shadow-sm ring-1 ring-black/5 dark:ring-white/10; }
    .btn-ghost { @apply bg-white dark:bg-neutral-900 hover:bg-neutral-50 dark:hover:bg-neutral-800; }
    .btn-primary { @apply bg-black text-white hover:bg-neutral-800 dark:bg-white dark:text-black dark:hover:bg-neutral-200; }
    .grad { background: radial-gradient(1200px 600px at 10% -10%, rgba(99,102,241,.18 ), transparent 50%),
                         radial-gradient(1000px 500px at 90% -20%, rgba(20,184,166,.18), transparent 50%); }
  </style>
</head>
<body class="h-full bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100">
  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur grad border-b border-neutral-200/70 dark:border-neutral-800/70">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="size-8 rounded-xl bg-black dark:bg-white text-white dark:text-black grid place-items-center font-bold">C</div>
        <div class="leading-tight">
          <div class="font-semibold">Critical Interpretation Protocol</div>
          <div class="text-xs text-neutral-500">Interactive Viewer</div>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnTheme" class="btn btn-primary" title="Toggle theme">Dark</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <!-- Documents Grid -->
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      <!-- Document 1 -->
      <div class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-black/5 dark:ring-white/10">
        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
          <h2 class="font-semibold text-lg">Critical Interpretation Protocol (CIP) v3.0</h2>
          <div class="flex gap-2">
            <button onclick="copyText('cip')" class="btn btn-ghost text-xs" title="Copy to clipboard">üìã Copy</button>
            <button onclick="downloadMd('cip')" class="btn btn-ghost text-xs" title="Download as .md file">‚¨áÔ∏è .md</button>
          </div>
        </div>
        <div class="p-6">
          <div id="doc-cip" class="prose prose-neutral dark:prose-invert prose-sm max-w-none max-h-[70vh] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Document 2 -->
      <div class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-black/5 dark:ring-white/10">
        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
          <h2 class="font-semibold text-lg">Speech Act Authority</h2>
          <div class="flex gap-2">
            <button onclick="copyText('speech')" class="btn btn-ghost text-xs" title="Copy to clipboard">üìã Copy</button>
            <button onclick="downloadMd('speech')" class="btn btn-ghost text-xs" title="Download as .md file">‚¨áÔ∏è .md</button>
          </div>
        </div>
        <div class="p-6">
          <div id="doc-speech" class="prose prose-neutral dark:prose-invert prose-sm max-w-none max-h-[70vh] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Document 3 -->
      <div class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-black/5 dark:ring-white/10">
        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
          <h2 class="font-semibold text-lg">Agent Constitution</h2>
          <div class="flex gap-2">
            <button onclick="copyText('constitution')" class="btn btn-ghost text-xs" title="Copy to clipboard">üìã Copy</button>
            <button onclick="downloadMd('constitution')" class="btn btn-ghost text-xs" title="Download as .md file">‚¨áÔ∏è .md</button>
          </div>
        </div>
        <div class="p-6">
          <div id="doc-constitution" class="prose prose-neutral dark:prose-invert prose-sm max-w-none max-h-[70vh] overflow-y-auto"></div>
        </div>
      </div>

      <!-- Document 4 -->
      <div class="bg-white dark:bg-neutral-900 rounded-2xl shadow-sm ring-1 ring-black/5 dark:ring-white/10">
        <div class="p-4 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
          <h2 class="font-semibold text-lg">Implementation Guide</h2>
          <div class="flex gap-2">
            <button onclick="copyText('implementation')" class="btn btn-ghost text-xs" title="Copy to clipboard">üìã Copy</button>
            <button onclick="downloadMd('implementation')" class="btn btn-ghost text-xs" title="Download as .md file">‚¨áÔ∏è .md</button>
          </div>
        </div>
        <div class="p-6">
          <div id="doc-implementation" class="prose prose-neutral dark:prose-invert prose-sm max-w-none max-h-[70vh] overflow-y-auto"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Templates removed -->

  <script>
    // ---- Data & State ----
    const DOCS = {
      'cip': { 
        label: 'Critical Interpretation Protocol (CIP) v3.0', 
        content: '',
        filename: 'critical_interpretation_protocol_v3.md'
      },
      'speech': { 
        label: 'Speech Act Authority', 
        content: '',
        filename: 'Speech_Act_Authority.md'
      },
      'constitution': { 
        label: 'Agent Constitution', 
        content: '',
        filename: 'Agent_Constitution_v3.md'
      },
      'implementation': { 
        label: 'Implementation Guide', 
        content: '',
        filename: 'CIP_v3_Implementation_Guide.md'
      }
    };

    // ---- DOM Elements ----
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => document.querySelectorAll(selector);

    // ---- Functions ----

    // Load content from external .md files
    async function loadDocumentContent() {
      const loadingHTML = '<div class="text-center py-8 text-neutral-500"><div class="animate-spin rounded-full h-8 w-8 border-2 border-neutral-300 border-t-neutral-600 mx-auto mb-2"></div>Loading content...</div>';
      
      // Show loading state
      for (const docId of Object.keys(DOCS)) {
        const docElement = $(`#doc-${docId}`);
        if (docElement) docElement.innerHTML = loadingHTML;
      }

      // Load all files
      const loadPromises = Object.entries(DOCS).map(async ([docId, doc]) => {
        try {
          console.log(`Loading: ${doc.filename}`);
          const response = await fetch(`./${doc.filename}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const content = await response.text();
          DOCS[docId].content = content;
          console.log(`‚úÖ Loaded: ${doc.filename} (${content.length} characters)`);
          
          return { docId, success: true, content };
        } catch (error) {
          console.error(`‚ùå Failed to load ${doc.filename}:`, error);
          
          // Fallback content for failed loads
          DOCS[docId].content = `# ${doc.label}

**‚ö†Ô∏è Content Loading Failed**

Could not load content from \`${doc.filename}\`.

**Possible causes:**
- File not found in root directory
- Network connectivity issues  
- Browser security restrictions for local files

**Solutions:**
1. Ensure \`${doc.filename}\` is in the same folder as \`index.html\`
2. Run via web server (not file:// protocol)
3. Check browser console for detailed error messages

---

*This is fallback content. The actual document should load automatically when the file is available.*`;
        
          return { docId, success: false, error };
        }
      });

      // Wait for all files to load
      const results = await Promise.allSettled(loadPromises);
      
      // Log results
      const successful = results.filter(r => r.status === 'fulfilled' && r.value.success).length;
      const failed = results.length - successful;
      
      console.log(`üìä Content Loading Summary: ${successful}/${results.length} files loaded successfully`);
      if (failed > 0) {
        console.warn(`‚ö†Ô∏è ${failed} files failed to load. Check network and file paths.`);
      }
    }

    // Render all documents
    function renderAllDocs() {
      for (const [docId, doc] of Object.entries(DOCS)) {
        const docElement = $(`#doc-${docId}`);
        if (!docElement) continue;

        try {
          // Render markdown
          const rawHTML = marked.parse(doc.content);
          docElement.innerHTML = rawHTML;
        } catch (error) {
          console.error(`Failed to render ${docId}:`, error);
          docElement.innerHTML = `<div class="text-red-500">Error rendering content: ${error.message}</div>`;
        }
      }
    }

    // Copy text to clipboard
    function copyText(docId) {
      const doc = DOCS[docId];
      if (!doc || !doc.content) {
        alert('Content not available for copying.');
        return;
      }
      
      // Try modern Clipboard API first
      if (navigator.clipboard && window.isSecureContext) {
        navigator.clipboard.writeText(doc.content).then(() => {
          showCopySuccess(event.target);
        }).catch(err => {
          console.warn('Clipboard API failed, trying fallback:', err);
          copyTextFallback(doc.content, event.target);
        });
      } else {
        // Use fallback method
        copyTextFallback(doc.content, event.target);
      }
    }

    // Fallback copy method for older browsers or unsecure contexts
    function copyTextFallback(text, button) {
      try {
        // Create temporary textarea
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        textarea.style.top = '-9999px';
        
        document.body.appendChild(textarea);
        textarea.select();
        textarea.setSelectionRange(0, 99999); // For mobile devices
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textarea);
        
        if (successful) {
          showCopySuccess(button);
        } else {
          throw new Error('execCommand failed');
        }
      } catch (err) {
        console.error('All copy methods failed:', err);
        alert('Could not copy text. Please select and copy manually.');
      }
    }

    // Show copy success feedback
    function showCopySuccess(button) {
      const originalText = button.innerHTML;
      button.innerHTML = '‚úÖ Copied!';
      button.classList.add('bg-green-100', 'dark:bg-green-900');
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('bg-green-100', 'dark:bg-green-900');
      }, 2000);
    }

    // Download as .md file
    function downloadMd(docId) {
      const doc = DOCS[docId];
      if (!doc || !doc.content) {
        alert('Content not available for download.');
        return;
      }
      
      const blob = new Blob([doc.content], { type: 'text/markdown' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      
      // Use original filename
      a.href = url;
      a.download = doc.filename;
      document.body.appendChild(a);
      a.click();
      
      // Cleanup
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      // Visual feedback
      const button = event.target;
      const originalText = button.innerHTML;
      button.innerHTML = '‚¨áÔ∏è Downloaded!';
      button.classList.add('bg-blue-100', 'dark:bg-blue-900');
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.classList.remove('bg-blue-100', 'dark:bg-blue-900');
      }, 2000);
    }

    // Theme Toggle
    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        $('#btnTheme').textContent = isDark ? 'Light' : 'Dark';
    }

    function initTheme() {
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            $('#btnTheme').textContent = 'Light';
        } else {
            document.documentElement.classList.remove('dark');
            $('#btnTheme').textContent = 'Dark';
        }
    }

    // ---- Initialization ----
    async function init() {
      console.log('üöÄ Initializing CIP Interactive Viewer...');
      
      // Load external content first
      await loadDocumentContent();
      
      // Then render everything
      renderAllDocs();
      initTheme();

      // Event Listeners
      $('#btnTheme').addEventListener('click', toggleTheme);
      
      console.log('‚úÖ Initialization complete');
    }

    // Start the application
    init();
  </script>
</body>
</html>
